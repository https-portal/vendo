<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PadWallet Registration</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Tesseract.js for OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- Cropper.js CSS & JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }

body {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #2563eb, #4bc7d8);
  color: #333;
}

/* Registration Box */
.register-box {
  background: #fff;
  border-radius: 15px;
  padding: 40px 30px;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  text-align: center;
}

.register-box h2 { color: #2563eb; margin-bottom: 25px; font-weight: 600; letter-spacing: 1px; }

input {
  width: 100%;
  padding: 12px 15px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  transition: all 0.3s ease;
}

input:focus {
  border-color: #2563eb;
  box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
  outline: none;
}

button {
  width: 100%;
  padding: 12px;
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 15px;
}

button:hover { background: #1e40af; }

p { margin-top: 15px; font-size: 14px; color: #555; }
a { color: #2563eb; text-decoration: none; font-weight: 500; }
a:hover { text-decoration: underline; }

#scannerStatus {
  margin-bottom: 15px;
  font-size: 14px;
  color: #2563eb;
  font-weight: 500;
}

/* Cropper Modal */
/* Cropper Modal */
#cropperModal {
  display: none;
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  overflow: auto;
  padding: 20px; /* Add some padding for small screens */
}

#cropperModal > div {
  background:#fff;
  border-radius:10px;
  max-width: 100%;
  width: 100%;
  max-height: 100%;
  display: flex;
  flex-direction: column;
  text-align: center;
  overflow: hidden;
}

#cropperImage {
  max-width: 100%;
  max-height: 70vh; /* Increase height for mobile */
  display: block;
  margin: auto;
  touch-action: none;
  flex-shrink: 0;
}

#cropBtn {
  margin-top: 10px;
  padding: 12px 20px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:16px;
  flex-shrink: 0;
}


@media (max-width: 400px) {
  .register-box { padding: 30px 20px; }
}
</style>
</head>
<body>

<!-- Cropper Modal -->
<div id="cropperModal">
  <div>
    <h3>Crop your ID</h3>
    <img id="cropperImage" />
    <button id="cropBtn">Crop & Scan</button>
  </div>
</div>

<!-- Registration Box -->
<div class="register-box">
  <h2>PadWallet Registration</h2>

  <input type="text" id="idNumber" placeholder="ID Number" />
  <input type="file" accept="image/*" capture="environment" id="idCapture" />
  <button type="button" onclick="scanID()">Scan ID</button>
  <div id="scannerStatus"></div>

  <input type="text" id="fullname" placeholder="Fullname" />
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />

  <button onclick="registerUser()">Register</button>
  <p>Already have an account? <a href="index.html">Login here</a></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCH_QogdKm5ugxqfUXiCKOH1UussXEn5r4",
  authDomain: "vendo-6c9d5.firebaseapp.com",
  projectId: "vendo-6c9d5",
  storageBucket: "vendo-6c9d5.firebasestorage.app",
  messagingSenderId: "424395684072",
  appId: "1:424395684072:web:b7b757d56f416c1864b15d",
  measurementId: "G-GQPV7Y72LH",
  databaseURL: "https://vendo-6c9d5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let cropper;

function scanID() {
  const fileInput = document.getElementById("idCapture");
  const status = document.getElementById("scannerStatus");

  if (!fileInput.files.length) return alert("Please take a photo of your ID!");

  const file = fileInput.files[0];
  const url = URL.createObjectURL(file);

  // Show modal
  const modal = document.getElementById("cropperModal");
  const image = document.getElementById("cropperImage");
  modal.style.display = "flex";
  image.src = url;

  // Destroy previous cropper
  if (cropper) cropper.destroy();
  cropper = new Cropper(image, {
    aspectRatio: 4/3,
    viewMode: 1,
    autoCropArea: 1,
    responsive: true,
    background: false,
    movable: true,
    zoomable: true,
    rotatable: false,
    scalable: false,
  });

  // Crop & OCR
  document.getElementById("cropBtn").onclick = function() {
    const canvas = cropper.getCroppedCanvas({ width: 1000 }); // resize for faster OCR
    canvas.toBlob(blob => {
      modal.style.display = "none";
      status.innerText = "Scanning ID... ⏳";

      Tesseract.recognize(blob, 'eng', {
        logger: m => {
          if (m.status === 'recognizing text') {
            status.innerText = `Scanning: ${Math.round(m.progress*100)}% ⏳`;
          }
        }
      }).then(({ data: { text } }) => {
        console.log("OCR Output:", text);

        const cleanText = text.replace(/\s+/g, " ").trim();
        const idMatch = cleanText.match(/\b(20\d{6}|2\d{7})\b/);
        document.getElementById("idNumber").value = idMatch ? idMatch[0] : "";

        const lines = text.split("\n").map(l => l.trim()).filter(l => l.length>0).map(l => l.replace(/[^a-zA-Z ]/g,""));
        let fullName = "";
        const skipWords = /University|Cebu|High|School|Signature|Name|Senior|ID|Sanciangko|Philippines/i;
        const namePattern = /^[A-Za-z]{2,}(?: [A-Za-z]{2,}){0,3}$/;
        for(let line of lines){
          if(skipWords.test(line)) continue;
          if(namePattern.test(line)){ fullName = line; break; }
        }
        if(fullName) fullName = fullName.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
        document.getElementById("fullname").value = fullName;

        status.innerText = "ID scanned successfully ✅";
      }).catch(err => {
        status.innerText = "";
        alert("Error scanning ID: "+err);
      });
    }, 'image/jpeg');
  };
}

// Firebase Registration
function registerUser() {
  const idNumber = document.getElementById("idNumber").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const fullname = document.getElementById("fullname").value.trim();

  if(!idNumber||!email||!password||!fullname){
    alert("All fields are required!");
    return;
  }

  db.ref('users').orderByChild('idNumber').equalTo(idNumber).once('value')
    .then(snapshot => {
      if(snapshot.exists()){
        alert("This ID Number is already registered!");
      } else {
        auth.createUserWithEmailAndPassword(email,password)
          .then(userCredential => {
            const user = userCredential.user;

            // ALWAYS use role = "user"
            return db.ref('users/' + user.uid).set({
              idNumber,
              email,
              fullname,
              role: "user"
            });
          })
          .then(() => {
            alert("Registration successful!");
            window.location.href = "index.html";
          })
          .catch(err => alert("Error: "+err.message));
      }
    })
    .catch(err => alert("Error checking ID: "+err.message));
}

</script>

</body>
</html>
